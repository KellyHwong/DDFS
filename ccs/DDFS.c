/*
 *  DDFS.c
 *  Created on: 2015年4月25日
 *  Author: HuangKan
 *  Description: 基础实验，SPWM与DDFS
 *
 *  Port: PA7，PWM波输出端
 */
#include <stdint.h>
#include <stdbool.h>
#include "inc/hw_types.h"
#include "inc/hw_memmap.h"
#include "inc/hw_ints.h"
#include "driverlib/sysctl.h"
#include "driverlib/gpio.h"
#include "driverlib/pin_map.h"
#include "driverlib/pwm.h"
#include "driverlib/timer.h"
#include "driverlib/interrupt.h"
#include "driverlib/rom.h"
#include "driverlib/fpu.h"

#include "DDFS.h"
#include "seg.h"
#include "UART0.h"
#include "buttons.h"
#include "nec.h"

DDFSAppState ddfsAPPState;
uint32_t ui32Buttons;
//正弦波表，0
//三角波表，1
//方波表，2
//锯齿波表，3
uint32_t waveTable[4][1000]={
		{512,515,518,522,525,528,531,535,538,541,544,547,551,554,557,560,563,567,570,573,576,579,583,586,589,592,595,598,602,605,608,611,614,617,621,624,627,630,633,636,639,642,646,649,652,655,658,661,664,667,670,673,676,679,682,685,688,691,694,697,700,703,706,709,712,715,718,721,724,727,730,733,736,739,742,744,747,750,753,756,759,761,764,767,770,773,775,778,781,784,786,789,792,794,797,800,802,805,808,810,813,816,818,821,823,826,828,831,833,836,838,841,843,846,848,851,853,855,858,860,862,865,867,869,872,874,876,879,881,883,885,887,890,892,894,896,898,900,902,904,907,909,911,913,915,917,919,920,922,924,926,928,930,932,934,935,937,939,941,943,944,946,948,949,951,953,954,956,958,959,961,962,964,965,967,968,970,971,972,974,975,977,978,979,981,982,983,984,986,987,988,989,990,992,993,994,995,996,997,998,999,1000,1001,1002,1003,1004,1005,1005,1006,1007,1008,1009,1009,1010,1011,1012,1012,1013,1014,1014,1015,1016,1016,1017,1017,1018,1018,1019,1019,1020,1020,1020,1021,1021,1021,1022,1022,1022,1023,1023,1023,1023,1023,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1023,1023,1023,1023,1023,1022,1022,1022,1021,1021,1021,1020,1020,1020,1019,1019,1018,1018,1017,1017,1016,1016,1015,1014,1014,1013,1012,1012,1011,1010,1009,1009,1008,1007,1006,1005,1005,1004,1003,1002,1001,1000,999,998,997,996,995,994,993,992,990,989,988,987,986,984,983,982,981,979,978,977,975,974,972,971,970,968,967,965,964,962,961,959,958,956,954,953,951,949,948,946,944,943,941,939,937,935,934,932,930,928,926,924,922,920,919,917,915,913,911,909,907,904,902,900,898,896,894,892,890,887,885,883,881,879,876,874,872,869,867,865,862,860,858,855,853,851,848,846,843,841,838,836,833,831,828,826,823,821,818,816,813,810,808,805,802,800,797,794,792,789,786,784,781,778,775,773,770,767,764,761,759,756,753,750,747,744,742,739,736,733,730,727,724,721,718,715,712,709,706,703,700,697,694,691,688,685,682,679,676,673,670,667,664,661,658,655,652,649,646,642,639,636,633,630,627,624,621,617,614,611,608,605,602,598,595,592,589,586,583,579,576,573,570,567,563,560,557,554,551,547,544,541,538,535,531,528,525,522,518,515,512,509,506,502,499,496,493,489,486,483,480,477,473,470,467,464,461,457,454,451,448,445,441,438,435,432,429,426,422,419,416,413,410,407,403,400,397,394,391,388,385,382,378,375,372,369,366,363,360,357,354,351,348,345,342,339,336,333,330,327,324,321,318,315,312,309,306,303,300,297,294,291,288,285,282,280,277,274,271,268,265,263,260,257,254,251,249,246,243,240,238,235,232,230,227,224,222,219,216,214,211,208,206,203,201,198,196,193,191,188,186,183,181,178,176,173,171,169,166,164,162,159,157,155,152,150,148,145,143,141,139,137,134,132,130,128,126,124,122,120,117,115,113,111,109,107,105,104,102,100,98,96,94,92,90,89,87,85,83,81,80,78,76,75,73,71,70,68,66,65,63,62,60,59,57,56,54,53,52,50,49,47,46,45,43,42,41,40,38,37,36,35,34,32,31,30,29,28,27,26,25,24,23,22,21,20,19,19,18,17,16,15,15,14,13,12,12,11,10,10,9,8,8,7,7,6,6,5,5,4,4,4,3,3,3,2,2,2,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,2,2,2,3,3,3,4,4,4,5,5,6,6,7,7,8,8,9,10,10,11,12,12,13,14,15,15,16,17,18,19,19,20,21,22,23,24,25,26,27,28,29,30,31,32,34,35,36,37,38,40,41,42,43,45,46,47,49,50,52,53,54,56,57,59,60,62,63,65,66,68,70,71,73,75,76,78,80,81,83,85,87,89,90,92,94,96,98,100,102,104,105,107,109,111,113,115,117,120,122,124,126,128,130,132,134,137,139,141,143,145,148,150,152,155,157,159,162,164,166,169,171,173,176,178,181,183,186,188,191,193,196,198,201,203,206,208,211,214,216,219,222,224,227,230,232,235,238,240,243,246,249,251,254,257,260,263,265,268,271,274,277,280,282,285,288,291,294,297,300,303,306,309,312,315,318,321,324,327,330,333,336,339,342,345,348,351,354,357,360,363,366,369,372,375,378,382,385,388,391,394,397,400,403,407,410,413,416,419,422,426,429,432,435,438,441,445,448,451,454,457,461,464,467,470,473,477,480,483,486,489,493,496,499,502,506,509},
		{0,2,4,6,8,10,12,14,16,18,20,23,25,27,29,31,33,35,37,39,41,43,45,47,49,51,53,55,57,59,61,63,66,68,70,72,74,76,78,80,82,84,86,88,90,92,94,96,98,100,102,104,106,109,111,113,115,117,119,121,123,125,127,129,131,133,135,137,139,141,143,145,147,150,152,154,156,158,160,162,164,166,168,170,172,174,176,178,180,182,184,186,188,190,193,195,197,199,201,203,205,207,209,211,213,215,217,219,221,223,225,227,229,231,233,236,238,240,242,244,246,248,250,252,254,256,258,260,262,264,266,268,270,272,274,276,279,281,283,285,287,289,291,293,295,297,299,301,303,305,307,309,311,313,315,317,319,322,324,326,328,330,332,334,336,338,340,342,344,346,348,350,352,354,356,358,360,362,365,367,369,371,373,375,377,379,381,383,385,387,389,391,393,395,397,399,401,403,406,408,410,412,414,416,418,420,422,424,426,428,430,432,434,436,438,440,442,444,446,449,451,453,455,457,459,461,463,465,467,469,471,473,475,477,479,481,483,485,487,489,492,494,496,498,500,502,504,506,508,510,512,514,516,518,520,522,524,526,528,530,532,535,537,539,541,543,545,547,549,551,553,555,557,559,561,563,565,567,569,571,573,575,578,580,582,584,586,588,590,592,594,596,598,600,602,604,606,608,610,612,614,616,618,621,623,625,627,629,631,633,635,637,639,641,643,645,647,649,651,653,655,657,659,662,664,666,668,670,672,674,676,678,680,682,684,686,688,690,692,694,696,698,700,702,705,707,709,711,713,715,717,719,721,723,725,727,729,731,733,735,737,739,741,743,745,748,750,752,754,756,758,760,762,764,766,768,770,772,774,776,778,780,782,784,786,788,791,793,795,797,799,801,803,805,807,809,811,813,815,817,819,821,823,825,827,829,831,834,836,838,840,842,844,846,848,850,852,854,856,858,860,862,864,866,868,870,872,874,877,879,881,883,885,887,889,891,893,895,897,899,901,903,905,907,909,911,913,915,918,920,922,924,926,928,930,932,934,936,938,940,942,944,946,948,950,952,954,956,958,961,963,965,967,969,971,973,975,977,979,981,983,985,987,989,991,993,995,997,999,1001,1004,1006,1008,1010,1012,1014,1016,1018,1020,1022,1024,1022,1020,1018,1016,1014,1012,1010,1008,1006,1004,1001,999,997,995,993,991,989,987,985,983,981,979,977,975,973,971,969,967,965,963,961,958,956,954,952,950,948,946,944,942,940,938,936,934,932,930,928,926,924,922,920,918,915,913,911,909,907,905,903,901,899,897,895,893,891,889,887,885,883,881,879,877,874,872,870,868,866,864,862,860,858,856,854,852,850,848,846,844,842,840,838,836,834,831,829,827,825,823,821,819,817,815,813,811,809,807,805,803,801,799,797,795,793,791,788,786,784,782,780,778,776,774,772,770,768,766,764,762,760,758,756,754,752,750,748,745,743,741,739,737,735,733,731,729,727,725,723,721,719,717,715,713,711,709,707,705,702,700,698,696,694,692,690,688,686,684,682,680,678,676,674,672,670,668,666,664,662,659,657,655,653,651,649,647,645,643,641,639,637,635,633,631,629,627,625,623,621,618,616,614,612,610,608,606,604,602,600,598,596,594,592,590,588,586,584,582,580,578,575,573,571,569,567,565,563,561,559,557,555,553,551,549,547,545,543,541,539,537,535,532,530,528,526,524,522,520,518,516,514,512,510,508,506,504,502,500,498,496,494,492,489,487,485,483,481,479,477,475,473,471,469,467,465,463,461,459,457,455,453,451,449,446,444,442,440,438,436,434,432,430,428,426,424,422,420,418,416,414,412,410,408,406,403,401,399,397,395,393,391,389,387,385,383,381,379,377,375,373,371,369,367,365,362,360,358,356,354,352,350,348,346,344,342,340,338,336,334,332,330,328,326,324,322,319,317,315,313,311,309,307,305,303,301,299,297,295,293,291,289,287,285,283,281,279,276,274,272,270,268,266,264,262,260,258,256,254,252,250,248,246,244,242,240,238,236,233,231,229,227,225,223,221,219,217,215,213,211,209,207,205,203,201,199,197,195,193,190,188,186,184,182,180,178,176,174,172,170,168,166,164,162,160,158,156,154,152,150,147,145,143,141,139,137,135,133,131,129,127,125,123,121,119,117,115,113,111,109,106,104,102,100,98,96,94,92,90,88,86,84,82,80,78,76,74,72,70,68,66,63,61,59,57,55,53,51,49,47,45,43,41,39,37,35,33,31,29,27,25,23,20,18,16,14,12,10,8,6,4,2},
		{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024,1024},
		{1024,1023,1022,1021,1020,1019,1018,1017,1016,1015,1014,1013,1012,1011,1010,1009,1008,1007,1006,1005,1003,1002,1001,1000,999,998,997,996,995,994,993,992,991,990,989,988,987,986,985,984,983,982,981,980,979,978,977,976,975,974,973,972,971,970,969,968,967,966,965,964,962,961,960,959,958,957,956,955,954,953,952,951,950,949,948,947,946,945,944,943,942,941,940,939,938,937,936,935,934,933,932,931,930,929,928,927,926,925,924,923,921,920,919,918,917,916,915,914,913,912,911,910,909,908,907,906,905,904,903,902,901,900,899,898,897,896,895,894,893,892,891,890,889,888,887,886,885,884,883,882,880,879,878,877,876,875,874,873,872,871,870,869,868,867,866,865,864,863,862,861,860,859,858,857,856,855,854,853,852,851,850,849,848,847,846,845,844,843,842,841,839,838,837,836,835,834,833,832,831,830,829,828,827,826,825,824,823,822,821,820,819,818,817,816,815,814,813,812,811,810,809,808,807,806,805,804,803,802,801,800,798,797,796,795,794,793,792,791,790,789,788,787,786,785,784,783,782,781,780,779,778,777,776,775,774,773,772,771,770,769,768,767,766,765,764,763,762,761,760,759,757,756,755,754,753,752,751,750,749,748,747,746,745,744,743,742,741,740,739,738,737,736,735,734,733,732,731,730,729,728,727,726,725,724,723,722,721,720,719,718,716,715,714,713,712,711,710,709,708,707,706,705,704,703,702,701,700,699,698,697,696,695,694,693,692,691,690,689,688,687,686,685,684,683,682,681,680,679,678,677,675,674,673,672,671,670,669,668,667,666,665,664,663,662,661,660,659,658,657,656,655,654,653,652,651,650,649,648,647,646,645,644,643,642,641,640,639,638,637,636,634,633,632,631,630,629,628,627,626,625,624,623,622,621,620,619,618,617,616,615,614,613,612,611,610,609,608,607,606,605,604,603,602,601,600,599,598,597,596,595,593,592,591,590,589,588,587,586,585,584,583,582,581,580,579,578,577,576,575,574,573,572,571,570,569,568,567,566,565,564,563,562,561,560,559,558,557,556,555,554,552,551,550,549,548,547,546,545,544,543,542,541,540,539,538,537,536,535,534,533,532,531,530,529,528,527,526,525,524,523,522,521,520,519,518,517,516,515,514,513,511,510,509,508,507,506,505,504,503,502,501,500,499,498,497,496,495,494,493,492,491,490,489,488,487,486,485,484,483,482,481,480,479,478,477,476,475,474,473,472,470,469,468,467,466,465,464,463,462,461,460,459,458,457,456,455,454,453,452,451,450,449,448,447,446,445,444,443,442,441,440,439,438,437,436,435,434,433,432,431,429,428,427,426,425,424,423,422,421,420,419,418,417,416,415,414,413,412,411,410,409,408,407,406,405,404,403,402,401,400,399,398,397,396,395,394,393,392,391,390,388,387,386,385,384,383,382,381,380,379,378,377,376,375,374,373,372,371,370,369,368,367,366,365,364,363,362,361,360,359,358,357,356,355,354,353,352,351,350,349,347,346,345,344,343,342,341,340,339,338,337,336,335,334,333,332,331,330,329,328,327,326,325,324,323,322,321,320,319,318,317,316,315,314,313,312,311,310,309,308,306,305,304,303,302,301,300,299,298,297,296,295,294,293,292,291,290,289,288,287,286,285,284,283,282,281,280,279,278,277,276,275,274,273,272,271,270,269,268,267,265,264,263,262,261,260,259,258,257,256,255,254,253,252,251,250,249,248,247,246,245,244,243,242,241,240,239,238,237,236,235,234,233,232,231,230,229,228,227,226,224,223,222,221,220,219,218,217,216,215,214,213,212,211,210,209,208,207,206,205,204,203,202,201,200,199,198,197,196,195,194,193,192,191,190,189,188,187,186,185,183,182,181,180,179,178,177,176,175,174,173,172,171,170,169,168,167,166,165,164,163,162,161,160,159,158,157,156,155,154,153,152,151,150,149,148,147,146,145,144,142,141,140,139,138,137,136,135,134,133,132,131,130,129,128,127,126,125,124,123,122,121,120,119,118,117,116,115,114,113,112,111,110,109,108,107,106,105,104,103,101,100,99,98,97,96,95,94,93,92,91,90,89,88,87,86,85,84,83,82,81,80,79,78,77,76,75,74,73,72,71,70,69,68,67,66,65,64,63,62,60,59,58,57,56,55,54,53,52,51,50,49,48,47,46,45,44,43,42,41,40,39,38,37,36,35,34,33,32,31,30,29,28,27,26,25,24,23,22,21,19,18,17,16,15,14,13,12,11,10,9,8,7,6,5,4,3,2,1,0}
};

int main(void) {
	//系统时钟50MHz
	SysCtlClockSet(SYSCTL_SYSDIV_4 | SYSCTL_USE_PLL | SYSCTL_XTAL_16MHZ |	SYSCTL_OSC_MAIN);
	//使能中断控制器
	IntMasterEnable();
	//开启浮点运算单元
	FPUEnable();
	APPinit();
	//PWM中断
	IntPrioritySet(INT_PWM1_3, 0x40);//中断优先级为2
	//解码计时器中断
	IntPrioritySet(INT_NEC_TIMER, 0x20);//中断优先级为1
	//红外端口中断
	IntPrioritySet(INT_INFRA_RED_PORT, 0x00);//中断优先级为0（最高）
	InfraPortInit();
	NECTimerInit();
	//LED灯初始化
	SysCtlPeripheralEnable(SYSCTL_PERIPH_GPIOF);
	GPIOPinTypeGPIOOutput(GPIO_PORTF_BASE, GPIO_PIN_1 | GPIO_PIN_2 | GPIO_PIN_3);
	while(1)
	{
		//频率实时变化
		ddfsAPPState.ddfsDiff = 1000.0*ddfsAPPState.freq/PWM_FREQ;
//		seg_display_num(ddfsAPPState.freq);
	}
	return 0;
}

void PWM_init()
{
	//使能端口
	SysCtlPeripheralEnable(SYSCTL_PERIPH_GPIOA);
	//使能外设
	SysCtlPeripheralEnable(SYSCTL_PERIPH_PWM1);
	//设置PWM时钟为系统时钟
	SysCtlPWMClockSet(SYSCTL_PWMDIV_1);
	//配置引脚功能
	GPIOPinConfigure(GPIO_PA7_M1PWM3);
	//配置引脚模式
	GPIOPinTypePWM(GPIO_PORTA_BASE,GPIO_PIN_7);
	//配置PWM
	PWMGenConfigure(PWM1_BASE, PWM_GEN_1, PWM_GEN_MODE_UP_DOWN | PWM_GEN_MODE_NO_SYNC);

	PWMGenPeriodSet(PWM1_BASE, PWM_GEN_1, ddfsAPPState.pwmPeroid);
	PWMPulseWidthSet(PWM1_BASE, PWM_OUT_3, ddfsAPPState.pwmWidth);
	//PWM产生模块使能
	PWMGenEnable(PWM1_BASE, PWM_GEN_1);
	//打开输出
	PWMOutputState(PWM1_BASE, PWM_OUT_3_BIT, true);
	//使能M1GEN1的中断
	PWMIntEnable(PWM1_BASE, PWM_INT_GEN_1);
	//计时到0则触发中断
	PWMGenIntTrigEnable(PWM1_BASE, PWM_GEN_1, PWM_INT_CNT_ZERO);
	//注册中断处理函数
	PWMGenIntRegister(PWM1_BASE, PWM_GEN_1, PWMIntHandler);
}

//更新占空比
void PWMIntHandler()
{
	//清除定时器中断
	PWMGenIntClear(PWM1_BASE, PWM_GEN_1, PWM_INT_CNT_ZERO);

//	GPIOPinWrite(GPIO_PORTF_BASE, GPIO_PIN_1|GPIO_PIN_2|GPIO_PIN_3, 0x00);
	ddfsAPPState.accPhase+=ddfsAPPState.ddfsDiff;
	while(ddfsAPPState.accPhase>=CYCLE_NUM) ddfsAPPState.accPhase-=CYCLE_NUM;//循环

	ddfsAPPState.tablePointer =(int)ddfsAPPState.accPhase;
	ddfsAPPState.pwmNum = waveTable[ddfsAPPState.waveChoose][ddfsAPPState.tablePointer];
	ddfsAPPState.pwmWidth = (int)ddfsAPPState.pwmNum * MAX_DUTY / 1024.0;
	PWMPulseWidthSet(PWM1_BASE, PWM_OUT_3, ddfsAPPState.pwmWidth);
}
void APPinit()
{
	//初始化DDFS相关数据
	ddfsAPPState.waveChoose=2;
	ddfsAPPState.freq=1000;
	ddfsAPPState.pwmPeroid = SysCtlClockGet()/PWM_FREQ;//50000000/20000=2500;
	ddfsAPPState.pwmWidth = 1024;
	ddfsAPPState.tablePointer = 0;
	ddfsAPPState.ddfsDiff = 0;
	ddfsAPPState.accPhase = 0;
	//初始化PWM发生器
	PWM_init();
	uart0_init();
	//初始化按键
	ButtonsInit();SW_init();

}
void SW_init()
{
	//低电平触发，因为按下是逻辑0
	GPIOIntTypeSet(GPIO_PORTF_BASE, SW1 | SW2, GPIO_FALLING_EDGE);
	GPIOIntEnable(GPIO_PORTF_BASE, SW1_INT | SW1_INT);
	GPIOIntClear(GPIO_PORTF_BASE, SW1_INT | SW1_INT);
	GPIOIntRegister(GPIO_PORTF_BASE, SWIntHandler);
}
void SWIntHandler()
{
	//按键按下进入中断服务程序（下降沿触发）
	GPIOIntClear(GPIO_PORTF_BASE, SW1_INT | SW1_INT);
	ui32Buttons = ~ (ROM_GPIOPinRead(GPIO_PORTF_BASE, SW1|SW2));
	//延时20ms去抖动
	SysCtlDelay(20*SysCtlClockGet()/3000);
	switch(ui32Buttons & ALL_SW)
	{
		case SW1:
			ddfsAPPState.freq++;
			//按键保持的话继续加频率
			while( ( (ui32Buttons=~ (ROM_GPIOPinRead(GPIO_PORTF_BASE, SW1|SW2))) & ALL_SW) == SW1)
			{
				SysCtlDelay(100*SysCtlClockGet()/3000);
				ddfsAPPState.freq++;
				seg_display_num(ddfsAPPState.freq);
			}
			break;
		case SW2:
			ddfsAPPState.freq--;
			while( ( (ui32Buttons=~ (ROM_GPIOPinRead(GPIO_PORTF_BASE, SW1|SW2))) & ALL_SW) == SW2)
			{
				SysCtlDelay(100*SysCtlClockGet()/3000);
				ddfsAPPState.freq--;
				seg_display_num(ddfsAPPState.freq);
			}
			break;
		default:
	}
}
